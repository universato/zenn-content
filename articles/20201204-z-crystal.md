---
title: "Crystalの除算"
emoji: "❄️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Crystal", "競プロ"]
published: false
---


# 最初に

今日は、Crystalが、`/`による整数どうしの割り算の返り値を、整数から浮動小数点数に変更した件について書きます。

この記事は駆け足で書いたので、あとで大幅に追記するかもしれません。

# 前提について

C言語やRubyなどでは、`/`による整数どうしの割り算の返り値は、切り捨ての整数が返ります。
この割り算をfloor divisionと呼びます。

また、今のPython 3は、`/`による整数どうしの割り算は、浮動小数点数が返ります。
これをfloat divisionと呼びます。

さて、Crystalは、`/`による整数どうしの割り算の返り値を整数から浮動小数点数に変更しました。
Crystalは、Rubyの文法・C言語の速さを謳い文句にしている言語です。
そのRuby・Crystalから離れる形で変更したのは、何故なのでしょう。
それについて、議論を覗いてみたいと思います。

# なぜCrystalの割り算の挙動は変更になったのか


[Make \`/\` be float division · Issue \#2968](https://github.com/crystal-lang/crystal/issues/2968)
2016/7/8に起案されたこのIssueが詳しいです。

もともとの提案が@pbruscoさんでしたが、
Ary Borenszweig(@asterite)氏が、改めてIssueを提案しています。
最初の提案は、以下です。(雰囲気で訳してます)

> Python 3と同じように、`/`が`float`を返すようにして、例えば`//`のような別の演算子を追加しましょう。
> `//`は、空の正規表現と被りますが、代わりに`%r`を使えばいいです。
>
> しかし、100%自信がないです。主な理由として、
> - 型は何にすべきでしょうか。`Float64`?
> - `x /= 2`は`x`の型を変えてしまいます。以前は変わらなかったのに。しかし、`x //= 2`を使えばいいでしょう。

これに対して、もちろん今のままRubyと同じであって欲しいという反対の意見もでてきます。
RubyからCrystalに流れ着いたユーザーが多くいることがわかります。

変更する理由は、Pythonが変更したときのPEP023
https://www.python.org/dev/peps/pep-0238/

とても基本的な演算子`/`の挙動を変更することは、大胆な変更に思えます。
今更変更するのはありえない、遅すぎるという反対意見もあります。
しかし、Pythonは、2->3で大きく変更しているので、それと比べてしまうとバージョン1.0未満でCrystalが変更しているのは、遅すぎるということもないのかなと思いました。ある意味、Pythonは2->3で後方互換性のない変更をしまくり、別の言語として生まれかわったのでしょうが、今Pythonは人気がありますし、悪い点については修正していくべきなのではないかと思います。

しかし、`/`を返すことは、悪いことなのでしょうか。`/`が浮動小数点数を返すことが大事なのでしょうか。

Ary Borenszweig(@asterite)氏の意見も見てると、当初は本人も反対でしたが、@pbrusco氏が強く変更を主張するため、気持ちが変わって好きになったらしいです。asterite氏が実際に`/`を実例を見ると、ほとんどの場所で`.0`か`to_f`がついて浮動小数点数を求める計算で使われていたとのことです。また、`x / 3`というコードを見たときに、コードを遡って`x`を見つけなければならない必要があることに気がついたようです。
どうも、実例を見て、`/`には多く使われているfloat divisionにした方がいい、コードを遡らないと何を返すかわからないのは読みにくくて良くないと思ったようです。
そうして、floor divisionをするメソッドは必要ですが、`/`に2つの意味を持たせる必要はないという結論に達したようです。改めてちゃんと説明すると、`/`は、整数のときはfloor divisionになり、浮動小数点数のときはfloat divisionになるというのが2つの意味です。確かに、`x / y`という式を見たときに整数なのか浮動小数点数なのかわかるのはいいことのように思えます。もちろん、変数名ですぐわかるのが理想かもしれませんが、手助けになるものが多いのはいいことでしょうね。

個人的には、`/`の実例がほとんど浮動小数点数を求めるものだったというのは、本当にそうなのかなという気持ちです。少なくとも競技プログラミングでは、整数どうしの割り算で整数を求めるときの方が多いように思います。このあたり、今まで意識してこなかったところなので、自分がコード書くときに注意深く見ていきたいです。

`/`はよく使われる記号です。
Rubyには、`/`の他に`fdiv`, `div`, `quo`のような割り算のメソッドがありますが、知名度が低いでしょう。
理想としては、1番使われる機能には、使いやすい記号をあてるべきでしょうね。

なお、`//`をもつ言語として、Python, Elm, Luaがあるそうです。
また、Visual Basicは、`\`としてのその演算子を持っているとのことです。

反対意見に、`/`は、常に、両方の数値を同じ型にキャストして除算するという意味は1つだけです。

## 最後に
